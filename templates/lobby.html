{% extends 'base.html' %}
{% block head %}
<style type="text/css">
.th-blue {
  background-color: #0074d9;
}
.th-red {
  background-color: #ff4136;
}
.avatar-cell {
  display: flex;
  justify-content: center;
}
td {
  padding-right: 1em;
}
.error-text {
  color: red;
}
.error-container {
  width: 595px;
}
.fade-enter-active, .fade-leave-active {
  transition: opacity .5s;
}
.fade-enter, .fade-leave-to {
  opacity: 0;
}
.list-enter-active, .list-leave-active {
  transition: opacity .5s;
}
.list-enter, .list-leave-to {
  opacity: 0;
}
</style>
{% endblock %}
{% block content %}
{% raw %}
<div v-cloak id="lobby">
  <center>
    <p>Share the game code <b>{{ gameCode }}</b> with your friends</p>
    <h3>Teams</h3>
    <table class="primary">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th>Team</th>
          <th>Role</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="player in players" v-bind:key="player.avatar">
          <td>
            <img class="avatar" :src="avataruri + player.avatar + '.png'"></img>
          </td>
          <td class="avatar-cell">
            <avatar :role="player.role" :team="player.team" />
          </td>
          <td>
            <select v-if="contains(player.id)" class="table-content" style="width: 150px" v-on:change="switchTeam(player.id)" v-bind:value="player.team">
              <option>Red</option>
              <option>Blue</option>
            </select>
            <select v-else class="table-content" style="width: 150px" disabled v-bind:value="player.team">
              <option>Red</option>
              <option>Blue</option>
            </select>
          </td>
          <td>
            <select v-if="contains(player.id)" class="table-content" style="width: 150px" v-on:change="switchRole(player.id)" v-bind:value="player.role">
              <option>Spymaster</option>
              <option>Player</option>
            </select>
            <select v-else class="table-content" style="width: 150px" disabled v-bind:value="player.role">
              <option>Spymaster</option>
              <option>Player</option>
            </select>
          </td>
        </tr>
      </tbody>
    </table>
    <button v-on:click="addPlayer">Add player</button>
    <button class="warning" v-on:click="startGame">Start Game</button>
  </center>
  <div class="error-container">
    <transition-group name="list" tag="p">
      <p v-for="error in errors" class="error-text" v-bind:key="error">
        {{ "Error: " + error }}
      </p>
    </transition-group>
  </div>
</div>
{% endraw %}
{% endblock %}
{% block scripts %}
{% raw %}
<script type="text/x-template" id="team-template">
  <table class="primary">
    <thead>
      <tr>
        <th v-bind:class="{
          'th-blue': color === 'BLUE',
          'th-red': color === 'RED',
        }">Player</th>
        <th v-bind:class="{
          'th-blue': color === 'BLUE',
          'th-red': color === 'RED',
        }">Role</th>
      </tr>
    </thead>
    <tbody>
      <!-- Empty item to maintain the table width if there are no items -->
      <template v-if="players.length === 0">
        <tr>
          <td></td>
          <td>
            <select style="width: 150px; visibility: hidden;"></select>
          </td>
        </tr>
      </template>
      <template v-else>
        <tr v-for="player in players" v-bind:key="player.avatar">
          <td class="avatar-cell">
            <avatar :role="player.role" :team="player.team" />
          </td>
          <td>
            <select v-if="player.id === playerid" class="table-content" style="width: 150px" v-on:change="onChange(player.id)" v-bind:value="player.role">
              <option>Spymaster</option>
              <option>Player</option>
            </select>
            <select v-else class="table-content" style="width: 150px" disabled v-bind:value="player.role">
              <option>Spymaster</option>
              <option>Player</option>
            </select>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
</script>
{% endraw %}
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/js.cookie.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/util.js') }}"></script>
<script type="text/javascript" charset="utf-8">
  var COOKIE_ID = 'CN_ID';
  var EVENT_SWITCH_ROLE = {{ LobbyEvent.SWITCH_ROLE.value|tojson|safe }};
  var EVENT_SWITCH_TEAM = {{ LobbyEvent.SWITCH_TEAM.value|tojson|safe }};
  var EVENT_CONNECT = {{ LobbyEvent.CONNECT.value|tojson|safe }};
  var EVENT_UPDATE = {{ LobbyEvent.UPDATE.value|tojson|safe }};
  var EVENT_SET_ID = {{ LobbyEvent.SET_ID.value|tojson|safe }};
  var EVENT_START_GAME = {{ LobbyEvent.START_GAME.value|tojson|safe }};
  var EVENT_INIT_START_GAME = {{ LobbyEvent.INIT_START_GAME.value|tojson|safe }};
  var EVENT_ADD_PLAYER = {{ LobbyEvent.ADD_PLAYER.value|tojson|safe }};
  var EVENT_RECEIVE_PLAYERS = {{ LobbyEvent.RECEIVE_PLAYERS.value|tojson|safe }};

  var avatarUri = {{ url_for('static', filename='img/avatar/')|tojson|safe }};
  var gameCode = {{ game_code|tojson|safe }};
  var players = [];
  var errors = [];
  var deviceIcon = getDeviceIcon(navigator.userAgent);

  // Connect to the socket server
  var serverUri = location.protocol+'//'+document.domain+':'+location.port;
  var socket = io.connect(serverUri);

  Vue.component('team', {
    template: '#team-template',
    props: {
      players: Array,
      color: String,
      playerid: String,
      avataruri: String
    },
    methods: {
      onChange: function(playerId) {
        socket.emit(EVENT_SWITCH_ROLE, playerId);
      }
    }
  });

  var Lobby = new Vue({
    el: '#lobby',
    data: {
      avatarUri: avatarUri,
      gameCode: gameCode,
      players: players,
      myplayers: [],
      errors: errors,
      avataruri: avatarUri
    },
    methods: {
      contains: function(id) {
        var contains = false;
        this.myplayers.forEach(function(player) {
          if (player.id === id) {
            contains = true;
          }
        });
        return contains;
      },
      addPlayer: function() {
        socket.emit(EVENT_ADD_PLAYER);
      },
      switchTeam: function(playerId) {
        socket.emit(EVENT_SWITCH_TEAM, playerId);
      },
      switchRole: function(playerId) {
        socket.emit(EVENT_SWITCH_ROLE, playerId);
      },
      startGame: function(event) {
        socket.emit(EVENT_INIT_START_GAME);
      }
    }
  });

  // Handles the initial connection of the player
  socket.on('connect', function() {
    var cookie = Cookies.getJSON(COOKIE_ID);
    socket.emit(EVENT_CONNECT, cookie);
  });

  socket.on(EVENT_SET_ID, function(cookie) {
    Cookies.set(COOKIE_ID, cookie);
    Lobby.myplayers = cookie.players;
  });

  socket.on(EVENT_RECEIVE_PLAYERS, function(cookie) {
    Cookies.set(COOKIE_ID, cookie);
    Lobby.myplayers = cookie.players;
  });

  // Handles initialization of lobby data
  socket.on(EVENT_UPDATE, function(data) {
    // clear the players list
    players.splice(0, players.length);

    // add in the new state
    data.players.forEach(function(player) {
      players.push(player);
    });
  });

  socket.on(EVENT_START_GAME, function(data) {
     window.location.href = data;
  });

  socket.on('error', function(error) {
    errors.push(error);
    setTimeout(function() {
      errors.shift();
    }, 10000);
  });

</script>
{% endblock %}
